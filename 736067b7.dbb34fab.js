(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{133:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return b})),a.d(t,"metadata",(function(){return l})),a.d(t,"rightToc",(function(){return o})),a.d(t,"default",(function(){return s}));var n=a(3),c=a(7),r=(a(0),a(230)),b={title:"\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4"},l={unversionedId:"topic/deployment/k8s-cluster-setup",id:"topic/deployment/k8s-cluster-setup",isDocsHomePage:!1,title:"\u4f7f\u7528kubeadm\u5b89\u88c5k8s\u96c6\u7fa4",description:"kubeadm HA\u6a21\u5f0f\u5b89\u88c5\u5b98\u65b9\u6587\u6863",source:"@site/docs\\topic\\deployment\\k8s-cluster-setup.md",slug:"/topic/deployment/k8s-cluster-setup",permalink:"/dddtdd-docs/docs/topic/deployment/k8s-cluster-setup",version:"current",lastUpdatedBy:"Colin Zuo",lastUpdatedAt:1606991537,sidebar:"docs",previous:{title:"\u4f7f\u7528ansible\u5de5\u7a0b\u90e8\u7f72",permalink:"/dddtdd-docs/docs/topic/deployment/deploy-use-ansible-project"},next:{title:"\u5206\u5e03\u5f0ftracing\u4ecb\u7ecd",permalink:"/dddtdd-docs/docs/topic/distributed-tracing/"}},o=[{value:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load balancer",id:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load-balancer",children:[]},{value:"\u5173\u95edswap",id:"\u5173\u95edswap",children:[]},{value:"\u5b89\u88c5docker-ce",id:"\u5b89\u88c5docker-ce",children:[]},{value:"\u5b89\u88c5kubelet kubeadm kubectl",id:"\u5b89\u88c5kubelet-kubeadm-kubectl",children:[]},{value:"\u5b89\u88c5kubectl bash completion",id:"\u5b89\u88c5kubectl-bash-completion",children:[]},{value:"\u4fee\u6539/etc/hosts",id:"\u4fee\u6539etchosts",children:[]},{value:"\u51c6\u5907kubeadm-config.yaml",id:"\u51c6\u5907kubeadm-configyaml",children:[]},{value:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5",id:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5",children:[]},{value:"\u5b89\u88c5calico",id:"\u5b89\u88c5calico",children:[]},{value:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165",id:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165",children:[]},{value:"\u5b89\u88c5k8s Dashboard",id:"\u5b89\u88c5k8s-dashboard",children:[]},{value:"\u52a0\u5165worker\u8282\u70b9",id:"\u52a0\u5165worker\u8282\u70b9",children:[]},{value:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6",id:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6",children:[]},{value:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6eVIP\u505a\u4e1a\u52a1HA",id:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6evip\u505a\u4e1a\u52a1ha",children:[]},{value:"\u62c6\u9664k8s\u96c6\u7fa4(\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6)",id:"\u62c6\u9664k8s\u96c6\u7fa4\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6",children:[]}],i={rightToc:o};function s(e){var t=e.components,a=Object(c.a)(e,["components"]);return Object(r.b)("wrapper",Object(n.a)({},i,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/"}),"kubeadm HA\u6a21\u5f0f\u5b89\u88c5\u5b98\u65b9\u6587\u6863")),Object(r.b)("h2",{id:"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load-balancer"},"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load balancer"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.jordyverbeek.nl/nieuws/kubernetes-ha-cluster-installation-guide"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo apt install -y keepalived haproxy\n\n# edit, update, restart keepalived\n# misc/kubeadm/keepalived.conf\nsudo cp keepalived.conf /etc/keepalived/\nsudo systemctl restart keepalived\n\n# edit, ,update, restart haproxy\n# misc/kubeadm/haproxy.cfg\nsudo cp haproxy.cfg /etc/haproxy/\nsudo systemctl restart haproxy\n")),Object(r.b)("p",null,"\u53c2\u8003keepalived.conf\u914d\u7f6e\u6587\u4ef6\u89c1harix-deploy/misc/kubeadm/keepalived.conf\uff0c\u5f53\u524d\u7248\u672c\u5982\u4e0b\uff0c\u4e0d\u540c\u73af\u5883\u7684virtual_router_id\u9700\u8981\u4e0d\u4e00\u6837\uff0c\u540c\u4e00\u4e2a\u73af\u5883\u7684\u4e0d\u540c\u673a\u5668\u7684priority\u5e94\u8be5\u4e0d\u4e00\u6837"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{}),"vrrp_instance VI_1 {\n    state MASTER\n    interface ens160\n    virtual_router_id 161\n    priority 101\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n    unicast_peer {\n        172.16.23.55\n        172.16.23.56\n        172.16.23.57\n    }\n    virtual_ipaddress {\n        172.16.23.61\n    }\n}\n")),Object(r.b)("p",null,"\u53c2\u8003haproxy.cfg\u914d\u7f6e\u6587\u4ef6\u89c1harix-deploy/misc/kubeadm/haproxy.cfg"),Object(r.b)("h2",{id:"\u5173\u95edswap"},"\u5173\u95edswap"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://serverfault.com/questions/684771/best-way-to-disable-swap-in-linux"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("h2",{id:"\u5b89\u88c5docker-ce"},"\u5b89\u88c5docker-ce"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/setup/production-environment/container-runtimes/"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("h2",{id:"\u5b89\u88c5kubelet-kubeadm-kubectl"},"\u5b89\u88c5kubelet kubeadm kubectl"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("h2",{id:"\u5b89\u88c5kubectl-bash-completion"},"\u5b89\u88c5kubectl bash completion"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubectl completion bash >/etc/bash_completion.d/kubectl\n")),Object(r.b)("h2",{id:"\u4fee\u6539etchosts"},"\u4fee\u6539/etc/hosts"),Object(r.b)("p",null,"\u9996\u5148\u8bbe\u7f6e\u673a\u5668\u7684hosts\u6587\u4ef6\uff0c\u4e00\u4e2a\u662fload balancer\u5730\u5740\uff0c\u6bd4\u5982\u4e0b\u976223.60\u662f\u524d\u9762lb\u4e0a\u914d\u7f6e\u7684vip\u5730\u5740\uff0c\u4e00\u4e2a\u662fharbor\u7684\u5730\u5740\u6bd4\u5982\u4e0b\u9762\u768413.133"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{}),"# edit /etc/hosts, such as\n172.16.23.60  harix45lb\n172.16.13.133 harbor.cloudminds.com\n")),Object(r.b)("h2",{id:"\u51c6\u5907kubeadm-configyaml"},"\u51c6\u5907kubeadm-config.yaml"),Object(r.b)("p",null,"\u7136\u540e\u51c6\u5907kubeadm-config.yaml\u6587\u4ef6\uff0c\u53c2\u8003\u89c1misc/kubeadm/kubeadm-config.yaml\uff0c\u5f53\u524d\u7248\u672c\u5185\u5bb9\u5982\u4e0b (\u7528\u4e8e61\u73af\u5883\uff0c\u5176\u5b83\u73af\u5883\u81f3\u5c11\u5e94\u6539lb\u5730\u5740)"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{}),'apiVersion: kubeadm.k8s.io/v1beta2\nkind: ClusterConfiguration\nkubernetesVersion: stable\ncontrolPlaneEndpoint: "harix45lb:443"\nnetworking:\n  podSubnet: 10.222.0.0/16\n')),Object(r.b)("h2",{id:"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5"},"\u8c03\u7528kubeadm\u5728\u7b2c\u4e00\u4e2amaster\u4e0a\u5b89\u88c5"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubeadm init --config=kubeadm-config.yaml --upload-certs\n")),Object(r.b)("h2",{id:"\u5b89\u88c5calico"},"\u5b89\u88c5calico"),Object(r.b)("p",null,"\u4e0b\u8f7d",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.projectcalico.org/v3.8/manifests/calico.yaml%E5%B9%B6%E6%8C%89%E7%85%A7%E5%89%8D%E9%9D%A2kubeadm-config.yaml%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9CALICO_IPV4POOL_CIDR%EF%BC%8C%E5%8F%AF%E5%AF%B9%E7%85%A7misc/kubeadm/calico.yaml"}),"https://docs.projectcalico.org/v3.8/manifests/calico.yaml\u5e76\u6309\u7167\u524d\u9762kubeadm-config.yaml\u6587\u4ef6\u4fee\u6539CALICO_IPV4POOL_CIDR\uff0c\u53ef\u5bf9\u7167misc/kubeadm/calico.yaml")),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubectl apply -f calico.yaml\n")),Object(r.b)("h2",{id:"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165"},"\u5728\u53e6\u5916\u8bbe\u8ba1\u4e3amaster\u7684\u673a\u5668\u4e0a\u7528kubeadm\u52a0\u5165"),Object(r.b)("p",null,"kubeadm init\u7ed3\u5c3e\u4f1a\u7ed9join\u9700\u8981\u6267\u884c\u7684\u547d\u4ee4"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubeadm join harix45lb:443 --token io7jk5.ndanb8hbe7cpn1q2 \\\n    --discovery-token-ca-cert-hash sha256:9eb562b0cabe93c48f6cb5e074ddcaa226d038d4fb201b6e49145267485d7296\n")),Object(r.b)("h2",{id:"\u5b89\u88c5k8s-dashboard"},"\u5b89\u88c5k8s Dashboard"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta1/aio/deploy/recommended.yaml\n")),Object(r.b)("p",null,"\u53c2\u7167kubespray\u5b9e\u73b0\uff0c\u53efapply misc/dashboard/dashboard-api.yaml\u6765\u5141\u8bb8\u96c6\u7fa4\u5916\u8bbf\u95eeapi\u4ece\u800c\u8bbf\u95eedashboard"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubectl apply -f dashboard-api.yaml\n")),Object(r.b)("h2",{id:"\u52a0\u5165worker\u8282\u70b9"},"\u52a0\u5165worker\u8282\u70b9"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/"}),"\u53c2\u8003\u6587\u6863")),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubeadm token create --print-join-command\n")),Object(r.b)("h2",{id:"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6"},"\u5b89\u88c5\u5fc5\u8981\u8f6f\u4ef6"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"sudo apt-get install -y python nfs-common\n")),Object(r.b)("h2",{id:"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6evip\u505a\u4e1a\u52a1ha"},"\u5728master\u4e0a\u4f7f\u7528keepalived\u914d\u7f6eVIP\u505a\u4e1a\u52a1HA"),Object(r.b)("p",null,"\u56e0\u4e3a\u5728\u4e1a\u52a1\u7cfb\u7edf\u7ecf\u5e38\u9700\u8981\u914d\u4e00\u4e2a\u5916\u90e8\u8bbf\u95ee\u5730\u5740\uff0c\u5982\u679c\u914d\u67d0\u53f0node\u7684\u56fa\u5b9aip\u7684\u8bdd\u5982\u679c\u8fd9\u53f0\n\u673a\u5668\u5b95\u673a\u4e86\u5916\u90e8\u8bbf\u95ee\u5c31\u4f1a\u4e2d\u65ad\uff0c\u5728\u6ca1\u6709\u4e13\u95e8load balancer\u8bbe\u5907\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528keepalived\u914d\u7f6eVIP\u6765\u5b9e\u73b0HA\\\n",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://tecadmin.net/setup-ip-failover-on-ubuntu-with-keepalived/"}),"\u53c2\u8003\u6587\u6863"),"\\\n",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/acassen/keepalived/issues/836"}),"\u6ce8\u610fissue"),"\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u8f7d\u6700\u65b0keepalived\u6e90\u7801\u7f16\u8bd1\u7136\u540e\u66ff\u6362\u7cfb\u7edf\u91cc\u7684keepalived\u7a0b\u5e8f\u66f4\u65b0"),Object(r.b)("pre",null,Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"cd /usr/sbin/\nmv keepalived keepalived.bak\nscp colinzuo@172.16.23.53:/usr/local/sbin/keepalived .\nsystemctl restart keepalived.service\nip addr del 172.16.23.60/32 dev ens160;ip addr\n")),Object(r.b)("p",null,"\u540c\u65f6\u53ef\u53c2\u8003\u524d\u9762",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"#%E5%AE%89%E8%A3%85%E5%9F%BA%E4%BA%8Ehaproxy%E7%9A%84load-balancer"}),"\u5b89\u88c5\u57fa\u4e8ehaproxy\u7684load-balancer"),"\u4e2d\u7684keepalived\u90e8\u5206"),Object(r.b)("h2",{id:"\u62c6\u9664k8s\u96c6\u7fa4\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6"},"\u62c6\u9664k8s\u96c6\u7fa4(\u91cd\u88c5\u6216\u5b89\u88c5\u9047\u5230\u95ee\u9898\u65f6)"),Object(r.b)("p",null,Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/"}),"\u53c2\u8003\u6587\u6863")))}s.isMDXComponent=!0},230:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return m}));var n=a(0),c=a.n(n);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function b(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?b(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):b(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,c=function(e,t){if(null==e)return{};var a,n,c={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(c[a]=e[a]);return c}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(c[a]=e[a])}return c}var i=c.a.createContext({}),s=function(e){var t=c.a.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=s(e.components);return c.a.createElement(i.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return c.a.createElement(c.a.Fragment,{},t)}},u=c.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,b=e.parentName,i=o(e,["components","mdxType","originalType","parentName"]),p=s(a),u=n,m=p["".concat(b,".").concat(u)]||p[u]||d[u]||r;return a?c.a.createElement(m,l(l({ref:t},i),{},{components:a})):c.a.createElement(m,l({ref:t},i))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,b=new Array(r);b[0]=u;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:n,b[1]=l;for(var i=2;i<r;i++)b[i]=a[i];return c.a.createElement.apply(null,b)}return c.a.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);